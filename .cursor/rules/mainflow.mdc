---
alwaysApply: true
---

# Scope Stats — UI & User Flow Spec (v2, Post‑Hierarchy Update)

**Purpose**: Single, living file that fully describes the MVP application’s UI and user flows so designers, engineers, QA, and stakeholders stay aligned. Optimized for **Expo React Native** + **expo-router**. Reflects the new flexible hierarchy, scoped roles, AI insights, and training‑linked org analytics.

---

## 0) How to Use This File

Treat each Screen and Flow as a self-contained spec block.

All blocks follow the same template (Intent → Entry Points → Permissions → Actions → States → Data → Layout → Components → Events → Strings → Edge Cases → Acceptance Criteria).

Keep scope clear with **[MVP]** vs **[Later]** tags. Update the **Changelog** when changes are made.

---

## 1) Product Context

### MVP Goals

* Capture **personal sessions** and **org trainings** (paper target scans & steel targets), then **learn** from stats and insights.
* Keep UI minimal: clear screens, **one primary CTA** per screen.
* Ensure **offline capture** with reliable sync and scoped caching.

### Target Users & Roles

* **org_admin** (organization owner/admin)
* **commander** (single generic role **scoped** by level and entity): `{ role: 'commander', scope_level: 'unit'|'team'|'squad', scope_id: UUID }`
* **instructor** (viewer/coach with comment rights; managed by a commander; scope-bound)
* **member** (regular user)

### Core Objects

* **Hierarchy**: Unit ▸ Team ▸ Squad (any subset allowed; e.g., just Unit, or Team‑only, or Team→Squad without Unit)
* **Trainings** (org‑only; linked to `unit` or `team` scope)
* **Sessions** (personal by default; may be explicitly linked to a training)
* **Loadouts**: weapon + sight + optional spotter equipment (no serials; just functional types)
* **Stats & Insights** (personal; scoped for commanders/instructors/org_admin)

### Key Policies

* **Personal vs Org Analytics**: All sessions count in **personal stats**. Sessions appear in **org/squad/team** analytics **only if linked to a training**.
* **Navigation Guard**: Users cannot navigate **above** their authorized scope (they may see limited “general overview” summaries when applicable).

---

## 2) Navigation Model (expo-router)

```
app/
  (auth)/sign-in.tsx
  (auth)/sign-up.tsx
  (auth)/onboarding.tsx
  (tabs)/dashboard.tsx          // context-aware landing
  (tabs)/sessions/index.tsx
  (tabs)/trainings/index.tsx    // role-gated create
  (tabs)/loadouts.tsx
  (tabs)/stats.tsx              // universal stats (personal & scoped)
  org/invitations.tsx
  settings.tsx
```

**Bottom Tabs**: Dashboard · Sessions · Trainings · Loadouts · Stats

**Top App Bar**: **Context switcher** (hierarchical drawer: Org ▸ Unit ▸ Team ▸ Squad ▸ Personal), role badge, filter icon (contextual), notifications.

**Landing Logic**:

* If user is a **commander**: default to **Dashboard** in **their scoped org context**.
* Else: default to **Personal Dashboard**.
* Context is switchable at any time via the top **Context Switcher** drawer.

---

## 3) Global Design System

### Design Tokens

* Colors: dark background; neutral surfaces; one brand accent.
* Spacing: 4/8 grid; cards rounded‑2xl; subtle elevation.
* Type: headline, subhead, body, caption.

### Common Components

* `HeaderContextSwitcher`
* `RoleBadge`
* `StatCard`, `KpiGrid`
* `ChartCard` (line/bar/heat)
* `FilterDrawer`, `TagChip`
* `SessionStepper` (wizard)
* `PaperScanAnalyzer`
* `SteelInputGrid`
* `LoadoutPicker`
* `InviteModal`
* `EmptyState`, `ErrorState`, `OfflineBanner`

### Interaction Patterns

* One **primary action** per screen
* Destructive actions require confirm modal
* Scope-aware filters persist per context

### Accessibility

* 44px min touch targets; dynamic font sizes; focus order; color contrast ≥ 4.5:1

---

## 4) Screen Inventory (Spec Blocks)

### Template

**Intent** · **Entry Points** · **Permissions/Context** · **Primary Actions** · **Secondary** · **Key States** · **Data Needed** · **Layout** · **Components** · **Events** · **Strings** · **Edge Cases** · **Acceptance Criteria**

---

### 4.1 Dashboard — Personal

**Intent**: Quick personal overview + start/resume most relevant action.

**Entry**: `/dashboard`, tab tap, post-auth (non-commander default).

**Permissions/Context**: Personal.

**Primary Actions**: **New Session**; **Resume Draft** (if exists).

**Secondary**: View Loadout; Open Stats (personal scope).

**Key States**: Empty (no sessions) · Loading · Success · Error · Offline (banner + cached stats)

**Data Needed**:

* My last session; my totals (sessions, targets, hit%), best & median grouping, last_zeroed_at
* Suggested drill (AI insight lite) [MVP]

**Layout**:

* Hero welcome card
* Quick KPIs (StatCard x4)
* Two mini charts: Hit% trend, Grouping trend
* Tiles: Last session · Suggested drill · Loadout

**Components**: `StatCard[]`, `ChartCard(line)`, `ChartCard(bar)`, `Tile`

**Events**: `dashboard_opened`, `cta_new_session_clicked`, `cta_resume_session_clicked`

**Strings**: “Welcome back, {name}” · “Hit %” · “Best grouping (cm)”

**Edge Cases**: No default loadout → show “Set Default Loadout” chip.

**Acceptance (MVP)**: Renders ≤1s with cached data; CTA navigations work; correct empty copy.

---

### 4.2 Dashboard — Scoped (Commander/Instructor)

**Intent**: Operational overview for the **current scope** (Unit/Team/Squad) — people & trainings, light mix matrix; not heavy analytics (moved to Stats).

**Entry**: `/dashboard` when in scoped context; commander default on sign-in.

**Permissions/Context**: commander/instructor within `scope_level` & `scope_id`.

**Primary Actions** (commander): **New Training**, **Invite Member**

**Secondary**: Export roster [Later], Open Stats (scope), Open Trainings

**Tabs**:

* **Overview** (default): KPI Grid (members, squads/teams, trainings, rule compliance, pending invites); Structure cards of children; quick drill‑down
* **Members & Trainings**: members list (role, joined, last trained, sessions); trainings list with open/close quick actions
* **Training Mix**: compact heat matrices: Position×Range; Role×Range; Weapon type counts within date range

**Filters**: date range; include/exclude personal sessions (default **exclude**); include **training‑linked only** (default **on**)

**Data Needed**: aggregates, frequency matrices (training‑linked only), members, invites, last training timestamps

**Layout**: List/cards; visual heat cells but no heavy charts

**Acceptance (MVP)**: Tabs render; counts match filters; drill‑down works; “New Training” opens scoped form.

---

### 4.3 Trainings — List

**Intent**: Find, start, or create trainings for the current scope.

**Entry**: `/trainings`

**Permissions**: commander can create; instructor/member read-only.

**Primary**: **New Training** (commander)

**States**: Empty → suggest creating; Loading; Error

**Data**: title, schedule, location, status, attached squads/teams; created_by

**Acceptance**: Filter by status/date; open detail; create/edit guarded by role.

---

### 4.4 Training — Detail

**Intent**: Single place for plan + rollup.

**Entry**: `/trainings/[id]`

**Primary**: **Add Session** (inside training), **Close Training** (commander)

**Sections**: Overview (goals) · What we trained (auto rollup, training‑linked sessions) · What to train next (gaps; AI hint) · Sessions tab · Attachments

**Acceptance**: Rollup reflects attached sessions; closing freezes edits (except commander/admin).

---

### 4.5 Sessions — Index

**Intent**: Browse and filter sessions; start new.

**Entry**: `/sessions`

**Primary**: **New Session**

**Filters**: date, type, position, weapon, distance, tags, wind class; Link status: **training‑linked** vs personal‑only

**Card Fields**: date, type, weapon, position, distance, shots, hits, hit%, cm dispersion (paper), tags, link badge (training)

**Acceptance**: List & filters performant; open detail; create new.

---

### 4.6 New Session (Stepper)

**Steps**: Context → Participants (org only) → Setup → Target → Review

**Setup**

* Distance (unit‑aware), position, wind (km/h + dir deg; UI may show compass)
* Loadout: weapon + sight; optional spotter **equipment** (visual/thermal/SWIR, etc.)

**Target**

* **Paper**: upload/scan/manual → compute `cm_dispersion`, POI offset; update `last_zeroed_at` only if zeroing rules met
* **Steel**: shots, hits, time‑to‑first (TTF), eliminated?

**Link to Training**

* Toggle to link the session to an active training (and squad/team context); **Only linked sessions count to org analytics**

**Validations**

* Distance required
* Paper requires image or manual inputs
* Steel requires shots/hits

**Acceptance (MVP)**

* Finish persists; Review shows computed metrics; drafts autosave; offline capture supported.

---

### 4.7 Loadouts

**Tabs**: My Loadouts · Org Armory (role‑aware view)

**Primary**: Add Loadout, **Set Default**

**Data**: weapon + sight; MV; zero distance; last_zeroed_at; spotter equipment (type: visual/thermal/SWIR…; no serials)

**Acceptance**: Selecting default updates **user_preferences**; prefilled in New Session.

---

### 4.8 Stats — Universal (Role‑aware)

**Intent**: Deep performance analysis **per scope**. Replaces prior fragmented commander analytics. AI insights embedded.

**Entry**: `/stats`

**Permissions/Context**:

* Everyone: **Personal** stats
* Scoped roles: Squad/Team/Unit (depending on authorization). **No upward nav** beyond level; show general overview summaries when above‑scope.

**Top Controls**:

* **Scope switcher** (Personal ▸ Squad ▸ Team ▸ Unit ▸ Org)
* Role filter chips: Sniper · Semi‑auto · Spotter
* Global filter drawer: date, weapon, distance, position, wind class, tags, **link status** (training‑linked vs personal)

**Sections**:

1. **KPIs**: sessions, shots, hits, hit %, median grouping (cm), avg TTF
2. **Role Panels** (small multiples per selected role):

   * Hit % by range (short/med/long)
   * Grouping by position (bar)
   * Trend lines (10 most recent)
   * Weapon performance (table)
3. **Roster/Leaderboard** (scope≠Personal): per user — sessions, hit %, median grouping, last trained; sortable
4. **Insights (AI/RAG)**: weakest area, recommended drills, under‑trained positions/ranges, “what to train next”
5. **Export**: CSV/PDF with active filters [MVP CSV; PDF Later]

**Acceptance (MVP)**: Filters apply across sections; role chips toggle data; roster shows only allowed scope; exports reflect filters.

---

### 4.9 Invitations

**Intent**: Accept/decline invites and create scoped invites.

**Primary**: Accept, Decline, Create Invite (commander/admin)

**States**: pending, accepted, expired

**Invite Payload**: `role`, `scope_level`, `scope_id`, optional `notes`

**Acceptance**: Guard expired/invalid; success creates membership; prompt to switch context.

---

### 4.10 Settings

**Sections**: Profile · Preferences (distance/angle units, default scope) · Org defaults · Integrations (Garmin placeholder) · Data export · Delete account

**Acceptance**: Changes persist; unit conversions honored across app.

---

## 5) End‑to‑End Flow Specs

### Flow A: Sign‑In / Sign‑Up / Onboarding

**Actors**: Any user

**Path**: sign‑in → (if new) sign‑up → onboarding (profile → role intent → consent)

**Guardrails**: email verified; helpful fail states

**Success**:

* **Commander** lands on **Scoped Dashboard**
* Others land on **Personal Dashboard**

---

### Flow B: Accept Org Invitation

**Actors**: Invitee

**Path**: deep link → Invitations → review scope & role → Accept

**Guardrails**: expired/invalid tokens; show retry/contact admin

**Success**: membership created; offer to switch to that scope

---

### Flow C: Create Training (Org)

**Actors**: commander/admin

**Path**: Trainings → New Training → form {title, scope (unit/team), squads/teams, time, goals} → Create

**Success**: Training detail opens; sessions can be linked; status scheduled

---

### Flow D: Create Session — Paper (Personal or Training‑linked)

**Actors**: any user

**Path**: Sessions → New → type=Paper → Setup (position, distance, loadout, wind) → Target (upload/scan/manual) → Analyze → Review → Save (optionally link to training)

**Compute**: `cm_dispersion`, POI offset; update `last_zeroed_at` if at zero distance and within tolerance

**Success**: Personal stats update; org stats update **only if linked**

---

### Flow E: Create Session — Steel (Personal or Training‑linked; Squad Mode)

**Actors**: any user; squad mode requires scoped context

**Path**: Training detail → Add Session → type=Steel → mode=Squad/Individual → Participants (add members, roles) → Setup → Target (shots, hits, TTF, eliminated?) → Review → Save

**Success**: Per‑participant rows created (allow `is_estimated=true` if only totals known)

---

### Flow F: Set Default Loadout

**Actors**: any user

**Path**: Loadouts → My Loadouts → Set Default

**Success**: New Session prefilled with this loadout; stored in `user_preferences`

---

### Flow G: Define Commander Rule [Later]

**Actors**: commander/admin

**Path**: Stats (scope) → Rules → New → pick metric + filters + threshold → Save

**Success**: Compliance shows on dashboards; insights reference rules

---

### Flow H: Offline Capture & Sync

**Actors**: any user

**Path**: Forms work offline → local draft → Sync on reconnect

**Guardrails**: conflict = last write wins (MVP) with audit; show **OfflineBanner** + “Last synced at …” indicator

**Success**: Seamless capture; scope caches for fast switching

---

## 6) Data Mapping (UI ↔️ Tables/Stores)

> High-level map (non-exhaustive). Names illustrative and aligned to Supabase.

**Hierarchy**

* `orgs` (id, name)
* `org_scopes` (id, org_id, level: 'unit'|'team'|'squad', name, parent_id nullable)
* `memberships` (user_id, org_id, role: 'org_admin'|'commander'|'instructor'|'member', scope_level?, scope_id?)

**Trainings & Sessions**

* `trainings` (id, org_id, scope_level, scope_id, title, schedule, location, goals, status)
* `session_stats` (id, user_id, org_id?, training_id?, type: 'paper'|'steel', position, distance_m, wind_speed_kmh, wind_dir_deg, wind_class, weapon_id, sight_id, equipment_id?, ttf_s?, created_at)
* `paper_targets` (session_id, cm_dispersion, poi_offset_x_cm, poi_offset_y_cm, image_uri, analysis_meta)
* `steel_targets` (session_id, shots, hits, eliminated bool)
* `session_participants` (session_id, user_id, user_role_at_session)
* `session_tags` (session_id, tag)
* Policy: Only sessions with `training_id` are counted in org analytics

**Loadouts & Equipment**

* `weapons` (id, name, caliber, mv_default, category)
* `sights` (id, name, type: 'visual'|'thermal'|'SWIR'|..., zoom_optics)
* `equipment` (id, name, type: 'spotter_scope'|'rangefinder'|'binoculars'|..., spectrum: visual/thermal/SWIR)
* `user_loadouts` (id, user_id, weapon_id, sight_id, equipment_id?, mv, zero_distance_m, last_zeroed_at)
* `user_preferences` (user_id PK, default_loadout_id, units_distance: 'm'|'yd', units_angle: 'mil'|'moa', default_scope?)

**Insights & Analytics**

* `ai_insights` (id, scope_type: 'user'|'squad'|'team'|'unit'|'org', scope_id, insight_type, payload_json, created_at)
* `commander_rules` [Later] (id, scope_level, scope_id, metric, filters_json, threshold)

**Events**

* analytics events emitted via client and/or RPC triggers

---

## 7) Events & Analytics (MVP)

* `auth_sign_in`, `auth_sign_up`, `onboarding_completed`
* `session_created` {type, training_linked, distance_m, position, wind_class}
* `paper_analyzed` {shot_count, cm_dispersion, poi_offset}
* `steel_saved` {participants, shots, hits}
* `training_created`, `training_closed`
* `insight_viewed` {scope_type, scope_id}
* `export_clicked` {scope, filters}

---

## 8) Copy & Microcopy (Examples)

* Empty Sessions: “No sessions yet. Let’s record your first one.”
* Analyze CTA: “Analyze target”
* Link to Training toggle: “Count this session in team stats”
* Wind hint: “Estimate wind at the target in km/h (we’ll convert for you).”
* Invite expired: “This invite has expired. Ask your commander to resend.”
* Offline: “You’re offline. Changes will sync automatically when you reconnect.”

---

## 9) Edge Cases & Policies

* **Units**: Store meters/mils internally; convert for UI
* **Wind**: Store numeric km/h + direction in degrees; UI may show compass labels
* **Squad Steel**: If only totals are known, set `is_estimated=true` per participant
* **Zeroing**: Update `last_zeroed_at` only on paper sessions at zero distance with tight dispersion
* **Permissions**: Commander-only actions are **hidden**, not disabled
* **Scope Cache**: Cache data per scope to enable fast switching and offline reads
* **Multi‑Org**: Users can belong to multiple orgs; context switcher supports switching org first, then scope

---

## 10) Acceptance Criteria (Global)

* All primary flows complete with no backend errors
* Screen loads ≤1s with cached data; ≤2.5s on network
* Forms validate inline; unit conversions correct
* Offline capture works; sync banner visible; last‑synced indicator present
* Org analytics exclude sessions **not** linked to trainings

---

## 11) Open Questions

1. Should training detail show **per‑target history** (steel) in MVP or Later?
2. Minimum photo resolution for paper analysis (device constraint)?
3. Do we add a lightweight **comment thread** component for instructors on Stats panels? [MVP or Later]

---

## 12) Changelog

* **v2.0 (This doc)** — Post‑Hierarchy Update: generic scoped commander role; universal Stats; training‑linked org analytics; instructor as viewer; hierarchical context switcher; offline scope caching.
* **v1.0** — Initial master spec created.