# .github/workflows/supabase-deploy.yml
name: Deploy Supabase Migrations

on:
  push:
    branches:
      - dev
      - main
    paths:
      - 'supabase/migrations/**'
      - 'supabase/config.toml'
  
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - dev
          - production

# Prevent concurrent deployments to same environment
concurrency:
  group: supabase-deploy-${{ github.event.inputs.environment || github.ref }}
  cancel-in-progress: false  # Never cancel running migrations!

jobs:
  # Deploy to DEV - Fast iteration
  deploy-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/dev' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'dev')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Verify migrations exist
        run: |
          if [ ! -d "supabase/migrations" ]; then
            echo "‚ùå No migrations directory found"
            exit 1
          fi
          
          if [ -z "$(ls -A supabase/migrations)" ]; then
            echo "‚ö†Ô∏è No migrations to apply"
            exit 0
          fi
          
          echo "‚úÖ Found migrations:"
          ls -la supabase/migrations/

      - name: Link to DEV
        run: supabase link --project-ref ${{ secrets.DEV_PROJECT_REF }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Check for destructive operations
        run: |
          echo "üîç Scanning for potentially destructive operations..."
          if grep -r "DROP TABLE\|DROP COLUMN\|ALTER TABLE.*DROP" supabase/migrations/ 2>/dev/null; then
            echo "‚ö†Ô∏è Warning: Destructive operations detected in migrations"
            echo "This is DEV environment - proceeding with caution"
          else
            echo "‚úÖ No destructive operations detected"
          fi
        continue-on-error: true

      - name: Deploy to DEV
        run: |
          supabase db push --password ${{ secrets.DEV_DB_PASSWORD }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Deployment Summary
        if: success()
        run: |
          echo "‚úÖ Successfully deployed to DEV"
          echo "üîó Project: https://app.supabase.com/project/${{ secrets.DEV_PROJECT_REF }}"
          echo "üìÖ Time: $(date)"
          echo "üîñ Commit: ${{ github.sha }}"

  # Deploy to PRODUCTION - Safety first!
  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    
    # CRITICAL: Require manual approval
    environment:
      name: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Verify migrations exist
        run: |
          if [ ! -d "supabase/migrations" ]; then
            echo "No migrations directory found"
            exit 1
          fi
          
          if [ -z "$(ls -A supabase/migrations)" ]; then
            echo "‚ö†Ô∏è No migrations to apply"
            exit 0
          fi
          
          echo "‚úÖ Found migrations:"
          ls -la supabase/migrations/

      - name: Link to PRODUCTION
        run: supabase link --project-ref ${{ secrets.PROD_PROJECT_REF }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: üö® Check for destructive operations
        id: destructive_check
        run: |
          echo "üîç Scanning for destructive operations..."
          
          if grep -r "DROP TABLE" supabase/migrations/ 2>/dev/null; then
            echo "found_drop_table=true" >> $GITHUB_OUTPUT
            echo "‚ùå CRITICAL: DROP TABLE detected!"
          fi
          
          if grep -r "DROP COLUMN\|ALTER TABLE.*DROP" supabase/migrations/ 2>/dev/null; then
            echo "found_drop_column=true" >> $GITHUB_OUTPUT
            echo "‚ùå CRITICAL: DROP COLUMN detected!"
          fi
          
          if grep -r "DROP DATABASE\|TRUNCATE" supabase/migrations/ 2>/dev/null; then
            echo "found_critical=true" >> $GITHUB_OUTPUT
            echo "‚ùå CRITICAL: Destructive operation detected!"
          fi

      - name: ‚ö†Ô∏è Stop if destructive operations found
        if: steps.destructive_check.outputs.found_drop_table == 'true' || steps.destructive_check.outputs.found_drop_column == 'true' || steps.destructive_check.outputs.found_critical == 'true'
        run: |
          echo "=============================================="
          echo "üö® DEPLOYMENT BLOCKED"
          echo "=============================================="
          echo ""
          echo "Destructive operations detected in migrations:"
          grep -r "DROP\|TRUNCATE" supabase/migrations/ || echo "See details above"
          echo ""
          echo "‚ö†Ô∏è This could cause DATA LOSS in production!"
          echo ""
          echo "To proceed:"
          echo "1. Review migrations carefully"
          echo "2. Ensure you have a recent backup"
          echo "3. Add a comment in migration explaining why this is safe"
          echo "4. Get explicit approval from team lead"
          echo "5. Use workflow_dispatch with manual confirmation"
          echo ""
          exit 1

      - name: Preview changes (DRY RUN)
        run: |
          echo "=============================================="
          echo "üìã PREVIEW: Changes that will be applied"
          echo "=============================================="
          supabase db diff --schema public || echo "Unable to compute diff"
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: ‚è∞ Deployment window check
        run: |
          HOUR=$(date -u +%H)
          DAY=$(date -u +%u)
          
          echo "Current time: $(date -u) UTC"
          echo "Day of week: $DAY (1=Monday, 7=Sunday)"
          echo "Hour: $HOUR"
          
          # Allow deployments Mon-Fri, 9AM-5PM UTC only (customize as needed)
          if [ $DAY -eq 6 ] || [ $DAY -eq 7 ]; then
            echo "‚ö†Ô∏è Weekend deployment detected!"
            echo "Proceeding with extra caution..."
          fi
          
          if [ $HOUR -lt 9 ] || [ $HOUR -gt 17 ]; then
            echo "‚ö†Ô∏è Off-hours deployment detected!"
            echo "Proceeding with extra caution..."
          fi

      - name: üéØ Deploy to PRODUCTION
        id: deploy
        run: |
          echo "üöÄ Starting production deployment..."
          echo "Commit: ${{ github.sha }}"
          echo "Triggered by: ${{ github.actor }}"
          
          supabase db push --password ${{ secrets.PROD_DB_PASSWORD }}
          
          echo "deployment_time=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: ‚úÖ Deployment Success Summary
        if: success()
        run: |
          echo "=============================================="
          echo "‚úÖ PRODUCTION DEPLOYMENT SUCCESSFUL"
          echo "=============================================="
          echo ""
          echo "üîó Project: https://app.supabase.com/project/${{ secrets.PROD_PROJECT_REF }}"
          echo "üìÖ Deployed at: ${{ steps.deploy.outputs.deployment_time }}"
          echo "üîñ Commit: ${{ github.sha }}"
          echo "üë§ Deployed by: ${{ github.actor }}"
          echo ""
          echo "üìù Post-deployment checklist:"
          echo "  [ ] Verify application is working"
          echo "  [ ] Check error logs"
          echo "  [ ] Monitor performance metrics"
          echo ""

      - name: üìù Rollback instructions
        if: always()
        run: |
          echo "=============================================="
          echo "üîÑ ROLLBACK INSTRUCTIONS"
          echo "=============================================="
          echo ""
          echo "If you need to rollback this deployment:"
          echo ""
          echo "1. Manual SQL rollback (fastest):"
          echo "   - Go to Supabase SQL Editor"
          echo "   - Run reverse migrations"
          echo ""
          echo "2. Restore from backup:"
          echo "   - Supabase Dashboard ‚Üí Database ‚Üí Backups"
          echo "   - Restore to before: ${{ steps.deploy.outputs.deployment_time }}"
          echo ""
          echo "3. Revert code and redeploy:"
          echo "   git revert ${{ github.sha }}"
          echo "   git push origin main"
          echo ""
          echo "Deployment commit: ${{ github.sha }}"
          echo "=============================================="

      - name: ‚ùå Deployment Failed
        if: failure()
        run: |
          echo "=============================================="
          echo "‚ùå PRODUCTION DEPLOYMENT FAILED"
          echo "=============================================="
          echo ""
          echo "üö® Immediate actions:"
          echo "  1. Check the logs above for error details"
          echo "  2. Verify database is still accessible"
          echo "  3. Alert the team immediately"
          echo "  4. Consider rolling back if partially applied"
          echo ""
          echo "üìû Contact on-call engineer if needed"
          echo ""
          exit 1